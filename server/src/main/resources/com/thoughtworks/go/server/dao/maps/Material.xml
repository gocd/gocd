<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2020 ThoughtWorks, Inc.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Material">
  <resultMap id="hg-material-map" type="com.thoughtworks.go.domain.materials.mercurial.HgMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="url" property="url"/>
    <result column="username" property="username"/>
    <result column="branch" property="branch"/>
  </resultMap>

  <resultMap id="svn-material-map" type="com.thoughtworks.go.domain.materials.svn.SvnMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="url" property="url"/>
    <result column="checkExternals" property="checkExternals"/>
    <result column="username" property="username"/>
  </resultMap>

  <resultMap id="git-material-map" type="com.thoughtworks.go.domain.materials.git.GitMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="url" property="url"/>
    <result column="username" property="username"/>
    <result column="branch" property="branch"/>
    <result column="submoduleFolder" property="submoduleFolder"/>
  </resultMap>

  <resultMap id="p4-material-map" type="com.thoughtworks.go.domain.materials.perforce.P4MaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="username" property="username"/>
    <result column="url" property="url"/>
    <result column="view" property="view"/>
    <result column="useTickets" property="useTickets"/>
  </resultMap>

  <resultMap id="dependency-material-map"
             type="com.thoughtworks.go.domain.materials.dependency.DependencyMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="pipelineName" property="pipelineName"/>
    <result column="stageName" property="stageName"/>
  </resultMap>

  <resultMap id="tfs-material-map" type="com.thoughtworks.go.domain.materials.tfs.TfsMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="url" property="url"/>
    <result column="username" property="username"/>
    <result column="projectPath" property="projectPath"/>
    <result column="domain" property="domain"/>
  </resultMap>

  <resultMap id="testing-material-map" type="com.thoughtworks.go.domain.materials.TestingMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="url" property="url"/>
  </resultMap>

  <resultMap id="package-material-map"
             type="com.thoughtworks.go.domain.materials.packagematerial.PackageMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="configuration" property="configuration"/>
  </resultMap>

  <resultMap id="plugin-material-map" type="com.thoughtworks.go.domain.materials.scm.PluggableSCMMaterialInstance">
    <result column="flyweightName" property="flyweightName"/>
    <result column="fingerprint" property="fingerprint"/>
    <result column="additionaldata" property="additionalData"/>
    <result column="configuration" property="configuration"/>
  </resultMap>

  <resultMap id="modification-map" type="com.thoughtworks.go.domain.materials.Modification">
    <id column="mod_id"/>
    <result column="mod_revision" property="revision"/>
    <result column="mod_comment" property="comment"/>
    <result column="mod_emailaddress" property="emailAddress"/>
    <result column="mod_modifiedtime" property="modifiedTime" javaType="date" jdbcType="TIMESTAMP"/>
    <result column="mod_username" property="userName"/>
    <result column="mod_pipelinelabel" property="pipelineLabel"/>
    <result column="mod_pipelineid" property="pipelineId" jdbcType="BIGINT"/>
    <result column="mod_additionaldata" property="additionalData"/>
    <collection property="materialInstance" resultMap="material-instance-map"/>
  </resultMap>

  <resultMap id="material-instance-map" type="com.thoughtworks.go.domain.MaterialInstance">
    <id column="id"/>
    <discriminator javaType="java.lang.String" column="type">
      <case value="HgMaterial" resultMap="hg-material-map"/>
      <case value="SvnMaterial" resultMap="svn-material-map"/>
      <case value="GitMaterial" resultMap="git-material-map"/>
      <case value="P4Material" resultMap="p4-material-map"/>
      <case value="DependencyMaterial" resultMap="dependency-material-map"/>
      <case value="TfsMaterial" resultMap="tfs-material-map"/>
      <case value="TestingMaterial" resultMap="testing-material-map"/>
      <case value="PackageMaterialInstance" resultMap="package-material-map"/>
      <case value="PluggableSCMMaterialInstance" resultMap="plugin-material-map"/>
    </discriminator>
  </resultMap>

  <select id="materialWithModifications" resultMap="modification-map">
    SELECT materials.id                AS id
         , materials.type
         , materials.url
         , materials.username
         , materials.checkexternals
         , materials.pipelinename
         , materials.stagename
         , materials.view
         , materials.branch
         , materials.submodulefolder
         , materials.usetickets
         , materials.fingerprint
         , materials.flyweightName
         , materials.projectpath
         , materials.domain
         , materials.configuration
         , materials.additionaldata

         , modification.id             AS mod_id
         , modification.username       AS mod_username
         , modification.comment        AS mod_comment
         , modification.emailaddress   AS mod_emailaddress
         , modification.revision       AS mod_revision
         , modification.modifiedtime   AS mod_modifiedtime
         , modification.fromexternal   AS mod_fromexternal
         , modification.pipelinelabel  AS mod_pipelinelabel
         , modification.pipelineid     AS mod_pipelineid
         , modification.additionaldata AS mod_additionaldata
    FROM materials
           INNER JOIN
         (
           SELECT *
           FROM (
                  SELECT ROW_NUMBER() OVER (PARTITION BY materialid ORDER BY id DESC) AS row_num, *
                  FROM modifications
                  ORDER BY materialid, row_num
                ) mod
           WHERE mod.row_num &lt;= #{count}
         ) modification ON modification.materialid = materials.id
  </select>
</mapper>
