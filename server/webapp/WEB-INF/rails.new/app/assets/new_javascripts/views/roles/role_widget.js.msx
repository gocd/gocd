/*
 * Copyright 2016 ThoughtWorks, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

define(["mithril", 'helpers/form_helper', 'helpers/mithril_component_mixins'], function (m, f, ComponentMixins) {
  var RoleWidget = {
    controller: function (args) {
      this.args = args;
      ComponentMixins.HasViewModel.call(this);

      var vmStateKey = 'show-' + args.role.name();

      this.vmState(vmStateKey, m.prop(false));

      this.toggleHide = function () {
        this.vmState(vmStateKey)(!this.vmState(vmStateKey)());
      };

      this.showState = function () {
        return this.vmState(vmStateKey)() ? 'show' : 'hide';
      };
    },

    view: function (ctrl, args) {
      var role = args.role;
      var image;
      var actionIcons;

      if (args.pluginInfo) {
        image       = (<img src={args.pluginInfo.image().toDataURI()}/>);
        actionIcons = (
          <div class="plugin-actions">
            <f.link class='edit-role' onclick={args.onEdit}/>
            <f.link class='delete-role-confirm' onclick={args.onDelete}/>
          </div>
        );
      } else {
        image       = (<span class="unknown-plugin-icon" title="Plugin not found"/>);
        actionIcons = (
          <div class="plugin-actions">
            <f.link class='edit-role disabled hidden' title="Plugin not found"/>
            <f.link class='delete-role-confirm' onclick={args.onDelete}/>
          </div>
        );
      }
      return (
        <div class="role">
          <div class="role-header" onclick={ctrl.toggleHide.bind(ctrl)}>
            <span class="plugin-icon">
              {image}
            </span>
            <div class="plugin-description">
              <div class="role-name"><span class="key">Id: </span><span class="value">{role.name()}</span></div>
              <div class="plugin-id"><span class="key">Auth Config ID:</span> <span
                class="value">{role.authConfigId()}</span></div>
            </div>

          </div>
          <div class={'plugin-config-read-only ' + ctrl.showState()}>
            <dl class="key-value-pair">

              {role.properties().mapConfigurations(function (configuration) {
                return [
                  (<dt>{configuration.key()}</dt>),
                  (<dd>
                    <pre>{configuration.value()}</pre>
                  </dd>)
                ];
              })}
            </dl>
          </div>
          {actionIcons}
        </div>
      );
    }
  };

  return RoleWidget;
});