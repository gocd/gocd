<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- *************************GO-LICENSE-START******************************
 * Copyright 2014 ThoughtWorks, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *************************GO-LICENSE-END******************************* -->

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>CCE Dashboard Tests</title>
    <link rel="stylesheet" type="text/css" href="../css/jsUnitStyle.css">
    <link rel="stylesheet" type="text/css" href="../css/jsUnitStyle.css">
    <script language="JavaScript" type="text/javascript" src="../app/jsUnitCore.js"></script>
    <script language="JavaScript" type="text/javascript" src="../app/jsUnitVersionCheck.js"></script>
    <script language="JavaScript" type="text/javascript" src="../app/jsTestHelper.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/jquery-1.7.2.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/prototype-1.6.0.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/angular.1.0.8.min.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/bootstrap-2.3.2.min.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/d3-3.1.5.min.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/lib.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/all.js"></script>
    <script language="JavaScript" type="text/javascript" src="../compressed/test_helper.js"></script>
<script type="text/javascript" src="../app/after_load_enhancements.js"></script>

    <script language="JavaScript" type="text/javascript">
        var agent;
        var agentPage;
        function setUp() {
            agentPage = new AgentPage();
            agent = new Agent('uuid');
            $("edit_resources_panel").hide();
            $("agentId").value = "";
        }

        function test_should_get_resources() {
            assertEquals("ajax", agent.get_resources()[0]);
            assertEquals("php", agent.get_resources()[1]);
            assertEquals("mysql", agent.get_resources()[2]);
        }

        function test_should_show_edit_resources_panel() {
            agent.get_resources = function() {
                return ["jdk1.4", "jdk1.5"]
            }
            agent.show_edit_resources_panel();
            assertTrue("edit_resources_panel should be visible.", $("edit_resources_panel").visible());
            assertEquals("", $("resources").value);
            assertEquals(agent.uuid, $("agentId").value);
        }

        function test_should_remove_resource() {
            agent.get_resources = function() {
                return ["jdk1.4", "jdk1.5"]
            }
            var invoked = false;
            agent._remote_edit_resources = function(param) {
                assertEquals("jdk1.5", param["agentResources"]);
                invoked = true;
            }
            agent.remove_resource("jdk1.4");
        }

        function test_should_append_user_input_after_current_resource() {
            agent.get_resources = function() {
                return ["jdk1.5"]
            }
            $("resources").value = "jdk1.6";
            var invoked = false;
            agent._remote_edit_resources = function(param) {
                invoked = true;
                assertEquals("jdk1.5,jdk1.6", param["agentResources"]);
            }
            agent.edit_resources();
            assertTrue("should invoke remote update", invoked);
        }

        function test_should_update_resources_and_invoke_process_on_template() {
            var invoked = false;
            var json_expected = [agent_resources('uuid')];
            String.prototype.process = function(json_actual) {
                invoked = true;
                assertEquals(json_expected[0].agentId, json_actual.objs[0].agentId);
            }
            agent.edit_resources_on_success(json_expected);
            assertTrue("template engine should try to render json", invoked)
        }
    </script>
</head>
<body>
<div id="uuid">
    <a title="Add Resources" ></a>
    <ul class="resources">
        <li><span>ajax</span>
            <a href="#" title="Remove">ss</a>
        </li>
        <li><span>php</span>
            <a href="#" title="Remove"></a>
        </li>
        <li><span>mysql</span>
            <a href="#" title="Remove"></a>
        </li>
        <div class="clear"></div>
    </ul>
    <div class="clear"></div>
    <div id="edit_resources_panel" class="positioned-panel" style="display: none;">
            <span class="notes">(separate multiple tags with commas)</span>
            <input id="agentId" type="hidden"/>
            <input id="resources" class="field"/>
            <div id="edit_resources_panel_error" class="error" style="display: ;">only a-z, A-Z, 0-9, _, -, |, dot, whitespace is available in tag name.</div>
            <script type="text/javascript">var checker = new InputChecker('resources', 'edit_resources_panel_error');</script>
            <p>
                <input type="button" id="editResources" onclick="agentPage.addResources()" value="Add resources"/>
                <input type="button" onclick="$('edit_resources_panel').hide()" value="Close"/>
            </p>
            <img id="edit_resources_panel_transport_spinner" src="$req.getContextPath()/images/spinner.gif" alt="transfering data" style="display: none;"/>
    </div>
    <textarea style="display: none;" id="agent-template">
        </textarea>
    <div id="agent-list"></div>
</div>
</body>
</html>
